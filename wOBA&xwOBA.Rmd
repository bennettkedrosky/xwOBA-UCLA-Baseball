```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)

filtered_data <- read.csv("V3 Merged Files Through 4-3 CLEANED.csv", encoding = "UTF-8") %>% select(Date, PitcherId, PitcherThrows, BatterId, BatterSide, KorBB, PlayResult, PitchCall, AutoHitType, HitType, OutsOnPlay, RunsScored, ExitSpeed, Angle, Direction, Distance, Barrel, Strikes)

filtered_bip <- filtered_data %>%
  filter((!is.na(ExitSpeed) | !is.na(Angle)))

filtered_data <- filtered_data %>%
  filter((PitchCall == "InPlay" & (!is.na(ExitSpeed) | !is.na(Angle))) | PlayResult=="Undefined")

```

```{r}
#from FanGraphs
constants <- data.frame(
  constant = c("1B", "2B", "3B", "HR", "HBP", "UBB"),
  values = c(0, 0, 0, 0, 0, 0) 
  )

constants[1, "values"] <- .89
constants[2, "values"] <- 1.27
constants[3, "values"] <- 1.62
constants[4, "values"] <- 2.1
constants[5, "values"] <- .72
constants[6, "values"] <- .69

constants[,"values", drop=FALSE]
```

```{r}
ev_groups <- seq(0, 120, by = 5)  
la_groups <- seq(-90, 90, by = 2) 
xwOBA_matrix <- matrix(0, nrow = length(ev_groups) - 1, ncol = length(la_groups) - 1)
colnames(xwOBA_matrix) <- paste("LA", head(la_groups, -1), "to", tail(la_groups, -1), sep = "_")
rownames(xwOBA_matrix) <- paste("EV", head(ev_groups, -1), "to", tail(ev_groups, -1), sep = "_")
count_matrix <- matrix(1, nrow = length(ev_groups) - 1, ncol = length(la_groups) - 1)
colnames(count_matrix) <- paste("LA", head(la_groups, -1), "to", tail(la_groups, -1), sep = "_")
rownames(count_matrix) <- paste("EV", head(ev_groups, -1), "to", tail(ev_groups, -1), sep = "_")
```

```{r}
for (i in 1:(nrow(filtered_bip))) {
  row_data <- filtered_bip[i, ]
  ev <- row_data$ExitSpeed
  la <- row_data$Angle
  
  count_1B <- 0
  count_2B <- 0
  count_3B <- 0
  count_HR <- 0
  count_OUT <- 0
  ev_index <- 1
  la_index <- 1
  
  for(ev_index in 1:length(ev_groups) - 1){
    if(ev >= ev_groups[ev_index] && ev < ev_groups[ev_index+1]){
      break
    }
  }
  for(la_index in 1:length(la_groups) - 1){
    if(la >= la_groups[la_index] && la < la_groups[la_index+1]){
      break
    }
  }
  
  result = row_data$PlayResult
  if (result == "Single") {
    count_1B <- 1
  } else if (result == "Double") {
    count_2B <- 1
  } else if (result == "Triple") {
    count_3B <- 1
  } else if (result == "HomeRun") {
    count_HR <- 1
  }
    else{
    count_OUT <- 1
  }

  
  xwOBA <- (count_1B * constants[1, "values"]) + (count_2B * constants[2, "values"]) + 
          (count_3B * constants[3, "values"]) + (count_HR * constants[4, "values"])
  
  if(count_matrix[ev_index, la_index] > 1){
      prevAvg = xwOBA_matrix[ev_index, la_index]
      xwOBA_matrix[ev_index, la_index] = (xwOBA + (prevAvg * count_matrix[ev_index, la_index]))/(count_matrix[ev_index, la_index] + 1)
  } else {
    xwOBA_matrix[ev_index, la_index] <- xwOBA
  }
    
  count_matrix[ev_index, la_index] = count_matrix[ev_index, la_index] + 1

}

```
